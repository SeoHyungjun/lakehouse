# Production Environment - Trino Configuration
# Production-grade deployment with high availability and security

trino:
  # Server configuration - production resources
  server:
    workers: 5
    
    coordinator:
      jvm:
        maxHeapSize: "8G"
        gcMethod:
          type: "UseG1GC"
          g1:
            heapRegionSize: "32M"
      
      config:
        general:
          query.max-memory: "50GB"
          query.max-memory-per-node: "10GB"
          query.max-total-memory-per-node: "12GB"
          query.max-concurrent-queries: 100
          
          # Spill to disk for large queries
          experimental.spill-enabled: true
          experimental.spiller-spill-path: /tmp/trino-spill
      
      resources:
        requests:
          memory: 8Gi
          cpu: 2000m
        limits:
          memory: 16Gi
          cpu: 4000m
      
      # Production node affinity
      nodeSelector:
        workload: analytics
      
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "analytics"
          effect: "NoSchedule"
    
    worker:
      jvm:
        maxHeapSize: "16G"
        gcMethod:
          type: "UseG1GC"
          g1:
            heapRegionSize: "32M"
      
      config:
        general:
          query.max-memory-per-node: "12GB"
          query.max-total-memory-per-node: "14GB"
          
          # Spill to disk for large queries
          experimental.spill-enabled: true
          experimental.spiller-spill-path: /tmp/trino-spill
      
      resources:
        requests:
          memory: 16Gi
          cpu: 4000m
        limits:
          memory: 32Gi
          cpu: 8000m
      
      # Autoscaling for production workloads
      autoscaling:
        enabled: true
        minReplicas: 5
        maxReplicas: 20
        targetCPUUtilizationPercentage: 70
      
      # Production node affinity
      nodeSelector:
        workload: analytics
      
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "analytics"
          effect: "NoSchedule"
      
      # Strict anti-affinity for high availability
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - trino
                  - key: component
                    operator: In
                    values:
                      - worker
              topologyKey: kubernetes.io/hostname

  # Catalogs - production endpoints
  additionalCatalogs:
    iceberg: |
      connector.name=iceberg
      iceberg.catalog.type=rest
      iceberg.rest.uri=http://iceberg-catalog.lakehouse-platform.svc.cluster.local:8181
      iceberg.rest.warehouse=s3://lakehouse-prod-warehouse/
      
      # S3 configuration
      fs.native-s3.enabled=true
      s3.endpoint=http://minio.lakehouse-platform.svc.cluster.local:9000
      s3.path-style-access=true
      s3.aws-access-key=${ENV:S3_ACCESS_KEY}
      s3.aws-secret-key=${ENV:S3_SECRET_KEY}
      
      # Performance optimizations
      iceberg.file-format=PARQUET
      iceberg.compression-codec=ZSTD
      iceberg.max-partitions-per-writer=100

  # Environment variables
  env:
    - name: S3_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: trino-s3-credentials
          key: accessKeyId
    - name: S3_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: trino-s3-credentials
          key: secretAccessKey

  # Authentication - required for production
  auth:
    enabled: true
    type: OAUTH2

  # Security - full TLS and access control
  security:
    tls:
      enabled: true
      port: 8443

  # Metrics - full observability for production
  metrics:
    enabled: true
    port: 9090

  # Ingress - production ingress with TLS
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    hosts:
      - host: trino.company.internal
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: trino-prod-tls
        hosts:
          - trino.company.internal

  # Pod annotations for production
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"

  # Service account with specific permissions
  serviceAccount:
    create: true
    annotations: {}
      # Add cloud provider annotations if needed
      # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/trino-role
    name: trino-prod

  # Pod security context - production hardening
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  # Container security context - production hardening
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000

# Secrets - production credentials (MUST be managed via external secrets manager)
# DO NOT commit actual production credentials to Git
secrets:
  s3:
    # These values should be overridden by external secrets operator
    accessKeyId: OVERRIDE_WITH_EXTERNAL_SECRET
    secretAccessKey: OVERRIDE_WITH_EXTERNAL_SECRET
