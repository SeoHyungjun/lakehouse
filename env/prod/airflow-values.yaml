# Airflow Production Environment Configuration
# Platform defaults: platform/airflow/values.yaml
# Override ONLY environment-specific values

airflow:
  # Production webserver with HA (3 replicas)
  webserver:
    replicas: 3
    resources:
      requests:
        memory: 1Gi
        cpu: 500m
      limits:
        memory: 2Gi
        cpu: 1000m

    # Pod anti-affinity for HA distribution
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - webserver
            topologyKey: kubernetes.io/hostname

  # Production scheduler with HA (3 replicas)
  scheduler:
    replicas: 3
    resources:
      requests:
        memory: 1Gi
        cpu: 500m
      limits:
        memory: 2Gi
        cpu: 1000m

    # Pod anti-affinity for HA distribution
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - scheduler
            topologyKey: kubernetes.io/hostname

  # PostgreSQL with production resources and read replicas
  postgresql:
    primary:
      persistence:
        size: 100Gi  # Production storage
      resources:
        requests:
          memory: 2Gi
          cpu: 1000m
        limits:
          memory: 4Gi
          cpu: 2000m

    # Read replicas for HA
    readReplicas:
      replicaCount: 2
      persistence:
        enabled: true
        size: 100Gi
      resources:
        requests:
          memory: 2Gi
          cpu: 1000m
        limits:
          memory: 4Gi
          cpu: 2000m

  # GitSync with production branch and SSH authentication
  dags:
    gitSync:
      enabled: true
      repo: "https://github.com/your-org/lakehouse-workflows.git"
      branch: main  # Production branch
      wait: 30
      maxFailures: 0  # Strict for production
      sshKeySecret: airflow-git-ssh-secret

  # Production Airflow configuration
  config:
    core:
      parallelism: 128  # High parallelism for production
      max_active_tasks_per_dag: 32
      max_active_runs_per_dag: 16
      dag_file_processor_timeout: 300

    webserver:
      expose_config: "False"  # Security: hide config in production
      rbac: "True"
      authenticate: "True"
      auth_backend: "airflow.api.auth.backend.basic_auth"
      web_server_worker_timeout: 300

    api:
      auth_backends: "airflow.api.auth.backend.basic_auth"
      enable_experimental_api: "False"

    kubernetes:
      delete_worker_pods: "True"
      delete_worker_pods_on_failure: "False"
      worker_pods_creation_batch_size: 10
      multi_namespace_mode: "False"
      pod_template_file: "/opt/airflow/pod_templates/pod_template.yaml"

    logging:
      logging_level: "INFO"
      remote_logging: "True"
      remote_base_log_folder: "s3://lakehouse-prod-logs/airflow"
      remote_log_conn_id: "aws_default"
      encrypt_s3_logs: "True"

    metrics:
      statsd_on: "True"
      statsd_host: "statsd-exporter"
      statsd_port: 9125
      statsd_prefix: "airflow"

  # Production metrics with high-frequency monitoring
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 15s  # More frequent for production
      scrapeTimeout: 10s
      labels:
        environment: production
        team: data-platform

  # Production ingress with strict TLS
  ingress:
    enabled: true
    web:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
      hosts:
        - name: airflow.company.internal
          tls:
            enabled: true
            secretName: airflow-prod-tls

  # Triggerer with HA (2 replicas) and affinity
  triggerer:
    enabled: true
    replicas: 2
    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 1Gi
        cpu: 500m

    # Soft anti-affinity for better distribution
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: component
                    operator: In
                    values:
                      - triggerer
              topologyKey: kubernetes.io/hostname

